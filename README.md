# üìò Creditos API (.NET 6, Kafka, Docker, PostgreSQL)


![2025-11-19-23-36-50 (online-video-cutter com) 00_00_00-00_00_30~1](https://github.com/user-attachments/assets/1c07637a-726b-4331-aa70-4c58d60be9eb)

API RESTful desenvolvida em **.NET 6** para integra√ß√£o e consulta de cr√©ditos constitu√≠dos, contendo:

- Publica√ß√£o de mensagens no Kafka
- Background service consumindo e persistindo cr√©ditos individualmente (n√£o em bulk)
- Endpoints REST completos
- Banco PostgreSQL em container
- Testes unit√°rios com xUnit
- Docker + Docker Compose
- Implementa√ß√£o com boas pr√°ticas de DDD, Clean Code e SOLID

## üì¶ Tecnologias Utilizadas

| Categoria       | Tecnologia                           |
|----------------|---------------------------------------|
| Linguagem      | **C# / .NET 6**                       |
| Web API        | ASP.NET Core / Controllers            |
| ORM            | **Entity Framework Core (Npgsql)**    |
| Banco          | **PostgreSQL** (containerizado)       |
| Mensageria     | **Kafka** (producer + consumer)       |
| Container      | Docker / Docker Compose               |
| Testes         | xUnit                                 |

## üèó Arquitetura do Projeto (DDD simplificado)

```
CreditApi/
‚îÇ
‚îú‚îÄ‚îÄ Controllers/          ‚Üí APIs REST (CreditController, HealthController)
‚îú‚îÄ‚îÄ Data/                 ‚Üí AppDbContext, Mappings
‚îú‚îÄ‚îÄ Background/           ‚Üí KafkaConsumerService
‚îú‚îÄ‚îÄ Services/             ‚Üí KafkaPublisher, CreditService
‚îú‚îÄ‚îÄ Repositories/         ‚Üí CreditoRepository (EF)
‚îú‚îÄ‚îÄ Models/               ‚Üí Entidade Credito
‚îú‚îÄ‚îÄ DTOs/                 ‚Üí Requests e Responses
‚îú‚îÄ‚îÄ Migrations/           ‚Üí Arquivos SQL
‚îî‚îÄ‚îÄ Program.cs
```

## üöÄ Como Rodar o Projeto (Docker)

> **Pr√©-requisitos:** Docker + Docker Compose

1. Ajuste as vari√°veis de ambiente no `docker-compose.yml` se necess√°rio.  
2. Execute:

```bash
docker compose up --build
```

3. A API estar√° dispon√≠vel em:

```
http://localhost:5000
```

4. Acesse o Swagger:

```
http://localhost:5000/swagger
```

## üî• Endpoints

### **POST /api/creditos/integrar-credito-constituido**

Recebe uma lista de cr√©ditos e envia **cada item como uma mensagem distinta** ao Kafka no t√≥pico:

```
integrar-credito-constituido-entry
```

#### ‚úî Retorno esperado:
```json
{
  "success": true
}
```

### **GET /api/creditos/{numeroNfse}**

Retorna todos os cr√©ditos referentes ao mesmo n√∫mero da NFS-e.

### **GET /api/creditos/credito/{numeroCredito}**

Retorna somente um cr√©dito espec√≠fico.

## üíæ Modelagem da Tabela

```sql
CREATE TABLE credito
(
    id                BIGINT GENERATED BY DEFAULT AS IDENTITY,
    numero_credito    VARCHAR(50)    NOT NULL,
    numero_nfse       VARCHAR(50)    NOT NULL,
    data_constituicao DATE           NOT NULL,
    valor_issqn       DECIMAL(15, 2) NOT NULL,
    tipo_credito      VARCHAR(50)    NOT NULL,
    simples_nacional  BOOLEAN        NOT NULL,
    aliquota          DECIMAL(5, 2)  NOT NULL,
    valor_faturado    DECIMAL(15, 2) NOT NULL,
    valor_deducao     DECIMAL(15, 2) NOT NULL,
    base_calculo      DECIMAL(15, 2) NOT NULL
);
```

## üîÑ Background Service

Um hosted service executa a cada **500 ms**:

- L√™ mensagens do Kafka
- Converte para objeto de dom√≠nio
- Insere **uma por vez** no banco (n√£o usa bulk)

## ‚ù§Ô∏è Endpoints de Sa√∫de

### ‚úî `/self`
Indica se o servi√ßo est√° ativo.

### ‚úî `/ready`
Indica se o servi√ßo est√° pronto (banco e Kafka funcionando).

## üß™ Testes Automatizados

- Projeto `CreditApi.Tests`
- Baseado em **xUnit**
- Testes exemplo incluem:
  - Reposit√≥rio
  - Servi√ßo
  - Valida√ß√µes

# üìã CHECKLIST DO DESAFIO

| Requisito | Status |
|----------|--------|
| .NET 6 | ‚úî |
| API RESTful | ‚úî |
| POST integrando cr√©ditos | ‚úî |
| Gera√ß√£o de mensagens individuais no Kafka | ‚úî |
| Consumer lendo a cada 500 ms | ‚úî |
| Inser√ß√£o individual (n√£o bulk) | ‚úî |
| Banco PostgreSQL em container | ‚úî |
| Persist√™ncia dos dados | ‚úî |
| GET por NFS-e | ‚úî |
| GET por n√∫mero do cr√©dito | ‚úî |
| Endpoints de sa√∫de | ‚úî |
| Dockerfile / docker-compose | ‚úî |
| C√≥digo limpo e organizado | ‚úî |
| Uso de padr√µes | ‚úî |
| Testes unit√°rios | ‚úî |
| README completo | ‚úî |

## üì¶ Checklist antes de subir no GitHub

‚úî Confirmar que todos os commits est√£o organizados  
‚úî Conferir `.dockerignore`  
‚úî Validar build com Docker  
‚úî Validar consumer e publisher  
‚úî Rodar testes unit√°rios  
‚úî Revisar Swagger  


## EXEMPLO DE DADOS
```
[

               {

                 "numeroCredito": "123456",

                 "numeroNfse": "7891011",

                 "dataConstituicao": "2024-02-25",

                 "valorIssqn": 1500.75,

                 "tipoCredito": "ISSQN",

                 "simplesNacional": "Sim",

                 "aliquota": 5.0,

                 "valorFaturado": 30000.00,

                 "valorDeducao": 5000.00,

                 "baseCalculo": 25000.00

               },

               {

                 "numeroCredito": "789012",

                 "numeroNfse": "7891011",

                 "dataConstituicao": "2024-02-26",

                 "valorIssqn": 1200.50,

                 "tipoCredito": "ISSQN",

                 "simplesNacional": "N√£o",

                 "aliquota": 4.5,

                 "valorFaturado": 25000.00,

                 "valorDeducao": 4000.00,

                 "baseCalculo": 21000.00

               },

               {

                 "numeroCredito": "654321",

                 "numeroNfse": "1122334",

                 "dataConstituicao": "2024-01-15",

                 "valorIssqn": 800.50,

                 "tipoCredito": "Outros",

                 "simplesNacional": "Sim",

                 "aliquota": 3.5,

                 "valorFaturado": 20000.00,

                 "valorDeducao": 3000.00,

                 "baseCalculo": 17000.00

               }

]
```
